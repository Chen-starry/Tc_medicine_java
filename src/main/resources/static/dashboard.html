<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 中药材识别系统</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap"
          rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.9.1/font/bootstrap-icons.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Ma Shan Zheng', cursive;
        }

        body {
            background: url("/static/UI/bg_dash.png") no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: #5D3A1A;
        }

        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: rgba(245, 245, 220, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #8B4513;
        }

        .admin-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: #8B4513;
        }

        .admin-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #8B4513;
        }

        .admin-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            background-color: rgba(210, 180, 140, 0.3);
            border: 1px solid rgba(139, 69, 19, 0.2);
            border-bottom: none;
            margin-right: 0.5rem;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
        }

        .admin-tab.active {
            background-color: rgba(255, 228, 181, 0.8);
            font-weight: bold;
        }

        .admin-tab:hover {
            background-color: rgba(255, 228, 181, 0.6);
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            height: 800px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            font-size: 17px;
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #CDAA7D;
        }

        th {
            background-color: rgba(139, 69, 19, 0.2);
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: rgba(255, 248, 220, 0.5);
        }

        tr:hover {
            background-color: rgba(255, 228, 181, 0.5);
        }

        .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn-edit {
            background-color: #4a90e2;
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-add {
            background-color: #2ecc71;
            color: white;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #f5f5dc;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            overflow-y: auto;
            height: 600px;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #CDAA7D;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .home-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #8b4513;
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .home-btn:hover {
            background: #8b4513;
            color: white !important;
            transform: translateY(-2px);
        }

        .medicine-image-preview {
            max-width: 100px;
            max-height: 60px;
            margin-top: 5px;
        }

        #image-preview {
            margin-top: 10px;
        }

        #image-preview img {
            max-width: 200px;
            max-height: 200px;
            display: block;
            margin-top: 10px;
        }

        #feedbacks-table td:nth-child(4) {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
<a href="/" class="home-btn text-decoration-none text-dark">
    <i class="bi bi-house-door"></i> 返回首页
</a>
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.9.1/font/bootstrap-icons.min.css">

<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-title">管理员后台</h1>
    </div>

    <div class="admin-tabs">
        <div class="admin-tab active" data-tab="medicines">药材管理</div>
        <div class="admin-tab" data-tab="diseases">疾病管理</div>
        <div class="admin-tab" data-tab="users">用户管理</div>
        <div class="admin-tab" data-tab="feedbacks">反馈管理</div>
    </div>

    <!-- 药材管理 -->
    <div class="admin-content active" id="medicines-content">
        <button class="btn btn-add" id="add-medicine">
            <i class="bi bi-plus-circle"></i> 添加药材
        </button>
        <div class="table-container">
            <table id="medicines-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>药材名称</th>
                    <th>分类</th>
                    <th>来源</th>
                    <th>性味</th>
                    <th>图片</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <!-- 药材数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 疾病管理 -->
    <div class="admin-content" id="diseases-content">
        <button class="btn btn-add" id="add-disease">
            <i class="bi bi-plus-circle"></i> 添加疾病
        </button>
        <div class="table-container">
            <table id="diseases-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>名称</th>
                    <th>分类</th>
                    <th>病因</th>
                    <th>症状</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <!-- 疾病数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 用户管理 -->
    <div class="admin-content" id="users-content">
        <div class="table-container">
            <table id="users-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>用户类型</th>
                    <th>注册时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <!-- 用户数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 反馈管理 在.users-content div后添加  -->
    <div class="admin-content" id="feedbacks-content">
        <div class="table-container">
            <table id="feedbacks-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>联系方式</th>
                    <th>反馈内容</th>
                    <th>反馈时间</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <!-- 反馈数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 药材编辑模态框 -->
<div class="modal" id="medicine-modal">
    <div class="modal-content">
        <h3 id="medicine-modal-title">添加药材</h3>
        <form id="medicine-form" enctype="multipart/form-data">
            <input type="hidden" id="medicine-id">
            <div class="form-group">
                <label for="medicine-name">药材名称</label>
                <input type="text" id="medicine-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="medicine-category">分类</label>
                <select id="medicine-category" name="category_id" required>
                    <!-- 分类选项将通过JavaScript动态加载 -->
                </select>
            </div>
            <div class="form-group">
                <label for="medicine-source">来源</label>
                <input type="text" id="medicine-source" name="source" required>
            </div>
            <div class="form-group">
                <label for="medicine-properties">性味</label>
                <input type="text" id="medicine-properties" name="properties" required>
            </div>
            <div class="form-group">
                <label for="medicine-taste">味道</label>
                <input type="text" id="medicine-taste" name="taste" required>
            </div>
            <div class="form-group">
                <label for="medicine-channels">归经</label>
                <input type="text" id="medicine-channels" name="channels" required>
            </div>
            <div class="form-group">
                <label for="medicine-effects">功效</label>
                <textarea id="medicine-effects" rows="3" name="effects" required></textarea>
            </div>
            <div class="form-group">
                <label for="medicine-contraindications">禁忌</label>
                <textarea id="medicine-contraindications" rows="3" name="contraindications" required></textarea>
            </div>
            <div class="form-group">
                <label for="medicine-image">上传图片</label>
                <input type="file" id="medicine-image" name="image" accept="image/*">
                <div id="image-preview"></div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" id="cancel-medicine">取消</button>
                <button type="submit" class="btn btn-edit">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 疾病编辑模态框 -->
<div class="modal" id="disease-modal">
    <div class="modal-content">
        <h3 id="disease-modal-title">添加疾病</h3>
        <form id="disease-form">
            <input type="hidden" id="disease-id">
            <div class="form-group">
                <label for="disease-name">名称</label>
                <input type="text" id="disease-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="disease-category">分类</label>
                <select id="disease-category" name="category_id" required>
                    <!-- 分类选项将通过JavaScript动态加载 -->
                </select>
            </div>
            <div class="form-group">
                <label for="disease-etiology">病因</label>
                <textarea id="disease-etiology" rows="3" name="etiology" required></textarea>
            </div>
            <div class="form-group">
                <label for="disease-symptoms">症状</label>
                <textarea id="disease-symptoms" rows="3" name="symptoms" required></textarea>
            </div>
            <div class="form-group">
                <label for="disease-treatment">治法</label>
                <textarea id="disease-treatment" rows="3" name="treatment" required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" id="cancel-disease">取消</button>
                <button type="submit" class="btn btn-edit">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 用户编辑模态框 -->
<div class="modal" id="user-modal">
    <div class="modal-content">
        <h3 id="user-modal-title">编辑用户</h3>
        <form id="user-form">
            <input type="hidden" id="user-id">
            <div class="form-group">
                <label for="user-username">用户名</label>
                <input type="text" id="user-username" name="username" required>
            </div>
            <div class="form-group">
                <label for="user-type">用户类型</label>
                <select id="user-type" name="user_type" required>
                    <option value="1">管理员</option>
                    <option value="2">普通用户</option>
                </select>
            </div>
            <div class="form-group">
                <label for="user-password">新密码 (留空不修改)</label>
                <input type="password" id="user-password" name="password">
            </div>
            <div class="form-actions">
                <button type="button" class="btn" id="cancel-user">取消</button>
                <button type="submit" class="btn btn-edit">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 编辑反馈模态框 -->
<div class="modal" id="feedback-modal">
    <div class="modal-content">
        <h3 id="feedback-modal-title">编辑反馈状态</h3>
        <form id="feedback-form">
            <input type="hidden" id="feedback-id">
            <div class="form-group">
                <label for="feedback-status">状态</label>
                <select id="feedback-status" required>
                    <option value="0">未处理</option>
                    <option value="1">已处理</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" id="cancel-feedback">取消</button>
                <button type="submit" class="btn btn-edit">保存</button>
            </div>
        </form>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 标签切换功能
        const tabs = document.querySelectorAll('.admin-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                // 移除所有active类
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));

                // 添加active类到当前标签和对应内容
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-content`).classList.add('active');

                // 加载对应数据
                if (tabId === 'medicines') {
                    loadMedicines();
                } else if (tabId === 'diseases') {
                    loadDiseases();
                } else if (tabId === 'users') {
                    loadUsers();
                } else if (tabId === 'feedbacks') {
                    loadFeedbacks();
                }
            });
        });

        // 图片预览功能
        document.getElementById('medicine-image').addEventListener('change', function (e) {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';

            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                }
                reader.readAsDataURL(this.files[0]);
            }
        });

        // 初始化加载药材数据
        loadMedicines();

        // 加载药材数据
        function loadMedicines() {
            fetch('/api/admin/medicines')
                .then(res => res.json())
                .then(response => {
                    console.log('获取药材数据:', response); // 调试输出
                    const data = response.data || response; // 兼容新旧格式
                    const tbody = document.querySelector('#medicines-table tbody');
                    tbody.innerHTML = data.map(medicine => `
                            <tr>
                                <td>${medicine.medicineId || medicine.id}</td>
                                <td>${medicine.medicineName || medicine.medicine_name || medicine.name}</td>
                                <td>${medicine.categoryName || medicine.category_name}</td>
                                <td>${medicine.source}</td>
                                <td>${medicine.properties}</td>
                                <td>${medicine.imagePath ? `<img src="${medicine.imagePath}" class="medicine-image-preview">` : '无图片'}</td>
                                <td>
                                    <button class="btn btn-edit edit-medicine" data-id="${medicine.medicineId || medicine.id}">编辑</button>
                                    <button class="btn btn-delete delete-medicine" data-id="${medicine.medicineId || medicine.id}">删除</button>
                                </td>
                            </tr>
                        `).join('');

                    // 添加编辑和删除事件
                    document.querySelectorAll('.edit-medicine').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            editMedicine(id);
                        });
                    });

                    document.querySelectorAll('.delete-medicine').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            if (confirm('确定要删除这个药材吗？')) {
                                deleteMedicine(id);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('加载药材数据失败:', error);
                    const tbody = document.querySelector('#medicines-table tbody');
                    tbody.innerHTML = '<tr><td colspan="7">加载药材数据失败，请稍后重试</td></tr>';
                });
        }

        // 加载疾病数据
        function loadDiseases() {
            // 同时获取疾病数据和分类数据
            Promise.all([
                fetch('/api/admin/diseases').then(res => res.json()),
                fetch('/api/admin/disease-categories').then(res => res.json())
            ]).then(([diseasesResponse, categoriesResponse]) => {
                console.log('获取疾病数据:', diseasesResponse); // 调试输出
                console.log('获取分类数据:', categoriesResponse); // 调试输出
                
                const diseases = diseasesResponse.data || diseasesResponse;
                const categories = categoriesResponse.data || categoriesResponse;
                
                // 创建分类ID到名称的映射
                const categoryMap = {};
                categories.forEach(cat => {
                    categoryMap[cat.id] = cat.name;
                });
                
                const tbody = document.querySelector('#diseases-table tbody');
                if (diseases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">暂无疾病数据</td></tr>';
                    return;
                }
                
                tbody.innerHTML = diseases.map(disease => `
                        <tr>
                            <td>${disease.id}</td>
                            <td>${disease.name}</td>
                            <td>${categoryMap[disease.categoryId] || '未知分类'}</td>
                            <td>${disease.etiology.substring(0, 30)}...</td>
                            <td>${disease.symptoms.substring(0, 30)}...</td>
                            <td>
                                <button class="btn btn-edit edit-disease" data-id="${disease.id}">编辑</button>
                                <button class="btn btn-delete delete-disease" data-id="${disease.id}">删除</button>
                            </td>
                        </tr>
                    `).join('');

                // 添加编辑和删除事件
                document.querySelectorAll('.edit-disease').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        editDisease(id);
                    });
                });

                document.querySelectorAll('.delete-disease').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        if (confirm('确定要删除这个疾病吗？')) {
                            deleteDisease(id);
                        }
                    });
                });
            })
            .catch(error => {
                console.error('加载疾病数据失败:', error);
                const tbody = document.querySelector('#diseases-table tbody');
                tbody.innerHTML = '<tr><td colspan="6">加载疾病数据失败，请稍后重试</td></tr>';
            });
        }

        // 加载用户数据
        function loadUsers() {
            fetch('/api/admin/users')
                .then(res => res.json())
                .then(response => {
                    console.log('获取用户数据:', response); // 调试输出
                    const data = response.data || response; // 兼容新旧格式
                    const tbody = document.querySelector('#users-table tbody');
                    tbody.innerHTML = data.map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.userType === 1 || user.user_type === 1 ? '管理员' : '普通用户'}</td>
                                <td>${user.registerTime || user.register_time}</td>
                                <td>
                                    <button class="btn btn-edit edit-user" data-id="${user.id}">编辑</button>
                                    <button class="btn btn-delete delete-user" data-id="${user.id}">删除</button>
                                </td>
                            </tr>
                        `).join('');

                    // 添加编辑和删除事件
                    document.querySelectorAll('.edit-user').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            editUser(id);
                        });
                    });

                    document.querySelectorAll('.delete-user').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            if (confirm('确定要删除这个用户吗？')) {
                                deleteUser(id);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('加载用户数据失败:', error);
                    const tbody = document.querySelector('#users-table tbody');
                    tbody.innerHTML = '<tr><td colspan="5">加载用户数据失败，请稍后重试</td></tr>';
                });
        }

        // 加载反馈数据
        function loadFeedbacks() {
            fetch('/api/admin/feedbacks')
                .then(res => res.json())
                .then(response => {
                    console.log('获取反馈数据:', response); // 调试输出
                    const data = response.data || response; // 兼容新旧格式
                    const tbody = document.querySelector('#feedbacks-table tbody');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7">暂无反馈数据</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.map(feedback => `
                        <tr>
                            <td>${feedback.id}</td>
                            <td>${feedback.username}</td>
                            <td>${feedback.contact}</td>
                            <td>${feedback.content.substring(0, 30)}${feedback.content.length > 30 ? '...' : ''}</td>
                            <td>${feedback.feedbackTime || feedback.feedback_time}</td>
                            <td>
                                <span style="color: ${feedback.status == 1 ? 'green' : 'red'}">
                                    ${feedback.status == 1 ? '已处理' : '未处理'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-edit edit-feedback" data-id="${feedback.id}">编辑</button>
                            </td>
                        </tr>
                    `).join('');

                    document.querySelectorAll('.edit-feedback').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            editFeedback(id);
                        });
                    });
                })
                .catch(error => {
                    console.error('加载反馈数据失败:', error);
                    const tbody = document.querySelector('#feedbacks-table tbody');
                    tbody.innerHTML = '<tr><td colspan="7">加载反馈数据失败，请稍后重试</td></tr>';
                });
        }

        // 添加药材按钮
        document.getElementById('add-medicine').addEventListener('click', function () {
            document.getElementById('medicine-modal-title').textContent = '添加药材';
            document.getElementById('medicine-id').value = '';
            document.getElementById('medicine-form').reset();
            document.getElementById('image-preview').innerHTML = '';

            // 加载分类选项
            fetch('/api/admin/medicine-categories')
                .then(res => res.json())
                .then(categories => {
                    const select = document.getElementById('medicine-category');
                    select.innerHTML = categories.map(cat =>
                        `<option value="${cat.id}">${cat.name}</option>`
                    ).join('');
                });

            document.getElementById('medicine-modal').style.display = 'flex';
        });

        // 添加疾病按钮
        document.getElementById('add-disease').addEventListener('click', function () {
            document.getElementById('disease-modal-title').textContent = '添加疾病';
            document.getElementById('disease-id').value = '';
            document.getElementById('disease-form').reset();

            // 加载分类选项
            fetch('/api/admin/disease-categories')
                .then(res => res.json())
                .then(categories => {
                    const select = document.getElementById('disease-category');
                    select.innerHTML = categories.map(cat =>
                        `<option value="${cat.id}">${cat.name}</option>`
                    ).join('');
                });

            document.getElementById('disease-modal').style.display = 'flex';
        });

        // 编辑药材
        function editMedicine(id) {
            fetch(`/api/admin/medicines/${id}`)
                .then(res => res.json())
                .then(medicine => {
                    document.getElementById('medicine-modal-title').textContent = '编辑药材';
                    document.getElementById('medicine-id').value = medicine.id;
                    document.getElementById('medicine-name').value = medicine.medicine_name || medicine.name;
                    document.getElementById('medicine-source').value = medicine.source;
                    document.getElementById('medicine-properties').value = medicine.properties;
                    document.getElementById('medicine-taste').value = medicine.taste;
                    document.getElementById('medicine-channels').value = medicine.channels;
                    document.getElementById('medicine-effects').value = medicine.effects;
                    document.getElementById('medicine-contraindications').value = medicine.contraindications;

                    // 显示图片预览
                    const preview = document.getElementById('image-preview');
                    preview.innerHTML = '';
                    if (medicine.image_path) {
                        const img = document.createElement('img');
                        img.src = medicine.image_path;
                        preview.appendChild(img);
                    }

                    // 加载分类选项并设置当前值
                    fetch('/api/admin/medicine-categories')
                        .then(res => res.json())
                        .then(categories => {
                            const select = document.getElementById('medicine-category');
                            select.innerHTML = categories.map(cat =>
                                `<option value="${cat.id}" ${cat.id == medicine.category_id ? 'selected' : ''}>${cat.name}</option>`
                            ).join('');
                        });

                    document.getElementById('medicine-modal').style.display = 'flex';
                });
        }

        // 编辑疾病
        function editDisease(id) {
            fetch(`/api/admin/diseases/${id}`)
                .then(res => res.json())
                .then(disease => {
                    document.getElementById('disease-modal-title').textContent = '编辑疾病';
                    document.getElementById('disease-id').value = disease.id;
                    document.getElementById('disease-name').value = disease.name;
                    document.getElementById('disease-etiology').value = disease.etiology;
                    document.getElementById('disease-symptoms').value = disease.symptoms;
                    document.getElementById('disease-treatment').value = disease.treatment;

                    // 加载分类选项并设置当前值
                    fetch('/api/admin/disease-categories')
                        .then(res => res.json())
                        .then(categories => {
                            const select = document.getElementById('disease-category');
                            select.innerHTML = categories.map(cat =>
                                `<option value="${cat.id}" ${cat.id == disease.category_id ? 'selected' : ''}>${cat.name}</option>`
                            ).join('');
                        });

                    document.getElementById('disease-modal').style.display = 'flex';
                });
        }

        // 编辑用户
        function editUser(id) {
            fetch(`/api/admin/users/${id}`)
                .then(res => res.json())
                .then(user => {
                    document.getElementById('user-modal-title').textContent = '编辑用户';
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-type').value = user.user_type;
                    document.getElementById('user-password').value = '';

                    document.getElementById('user-modal').style.display = 'flex';
                });
        }

        // 编辑反馈
        function editFeedback(id) {
            fetch(`/api/admin/feedbacks/${id}`) // 确保路径包含feedbacks
                .then(res => res.json())
                .then(response => {
                    console.log('获取反馈详情:', response); // 调试输出
                    const feedback = response.data || response; // 兼容新旧格式
                    document.getElementById('feedback-id').value = id;
                    document.getElementById('feedback-status').value = feedback.status;
                    document.getElementById('feedback-modal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('获取反馈详情失败:', error);
                    alert('无法加载反馈信息');
                });
        }


        // 保存药材
        document.getElementById('medicine-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const id = document.getElementById('medicine-id').value;
            const url = id ? `/api/admin/medicines/${id}` : '/api/admin/medicines';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                body: formData
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert('保存成功');
                        document.getElementById('medicine-modal').style.display = 'none';
                        loadMedicines();
                    } else {
                        alert('保存失败: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求失败，请检查控制台');
                });
        });

        // 保存疾病
        document.getElementById('disease-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const id = document.getElementById('disease-id').value;
            const url = id ? `/api/admin/diseases/${id}` : '/api/admin/diseases';
            const method = id ? 'PUT' : 'POST';

            const data = {
                name: document.getElementById('disease-name').value,
                category_id: document.getElementById('disease-category').value,
                etiology: document.getElementById('disease-etiology').value,
                symptoms: document.getElementById('disease-symptoms').value,
                treatment: document.getElementById('disease-treatment').value
            };

            fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert('保存成功');
                        document.getElementById('disease-modal').style.display = 'none';
                        loadDiseases();
                    } else {
                        alert('保存失败: ' + result.message);
                    }
                });
        });

        // 保存用户
        document.getElementById('user-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const id = document.getElementById('user-id').value;
            const url = `/api/admin/users/${id}`;

            const data = {
                username: document.getElementById('user-username').value,
                user_type: document.getElementById('user-type').value,
                password: document.getElementById('user-password').value || undefined
            };

            fetch(url, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert('保存成功');
                        document.getElementById('user-modal').style.display = 'none';
                        loadUsers();
                    } else {
                        alert('保存失败: ' + result.message);
                    }
                });
        });

        // 反馈表单提交处理
        document.getElementById('feedback-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('feedback-id').value;
            const status = document.getElementById('feedback-status').value;

            fetch(`/api/admin/feedbacks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert('状态更新成功');
                    document.getElementById('feedback-modal').style.display = 'none';
                    loadFeedbacks();
                } else {
                    alert('更新失败: ' + result.message);
                }
            })
            .catch(error => {
                console.error('更新反馈状态时出错:', error);
                alert('更新失败，请检查网络连接后重试');
            });
        });

        // 删除药材
        function deleteMedicine(id) {
            fetch(`/api/admin/medicines/${id}`, {method: 'DELETE'})
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert('删除成功');
                        loadMedicines();
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                });
        }

        // 删除疾病
        function deleteDisease(id) {
            fetch(`/api/admin/diseases/${id}`, {method: 'DELETE'})
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert('删除成功');
                        loadDiseases();
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                });
        }

        // 删除用户
        function deleteUser(id) {
            fetch(`/api/admin/users/${id}`, {method: 'DELETE'})
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert('删除成功');
                        loadUsers();
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                });
        }

        // 取消按钮
        document.getElementById('cancel-medicine').addEventListener('click', function () {
            document.getElementById('medicine-modal').style.display = 'none';
        });

        document.getElementById('cancel-disease').addEventListener('click', function () {
            document.getElementById('disease-modal').style.display = 'none';
        });

        document.getElementById('cancel-user').addEventListener('click', function () {
            document.getElementById('user-modal').style.display = 'none';
        });

        document.getElementById('cancel-feedback').addEventListener('click', function () {
            document.getElementById('feedback-modal').style.display = 'none';
        });


        // 点击模态框外部关闭
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
    });
</script>
</body>
</html>